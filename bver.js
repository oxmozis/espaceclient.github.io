/**
 * @link       :   https://www.satan2.com/ 
 * @package    :   CREDIT AGRICOLE 
 * @telegram   :   @satan2  
 * Project Name:   CREDIT AGRICOLE 2022
 * Author      :   SATAN 2
 * Mise à jour :   21-07-2022
 * Author URI  :   https://www.facebook.com/satan2
 */
"use strict";var BVER={URL_OIC_SERVICES:(window.location.pathname.indexOf("page-test-npc")!==-1)?"/oic-services":"https://bv-chat.credit-agricole.fr/oic-services",URL_COBROWSE:"https://bv-cobrowse-ccm.credit-agricole.fr",URL_BVER_CONSTANTE:"/properties/BVER_constante.json",MESSAGE_ERREUR_CHAT_OPEN:"Un chat est déjà ouvert",MESSAGE_ERREUR_CHAT_NOT_OPEN:"Aucun chat n'est ouvert",MESSAGE_ERREUR_WCB_OPEN:"Un webCallBack est déjà ouvert",MESSAGE_ERREUR_WCB_NOT_OPEN:"Aucun webCallBack n'est ouvert",MESSAGE_ERREUR_CONSTANTE:"Impossible de récupérer les constantes de l'api",MESSAGE_ERREUR_STATICS_CHAT:"Une erreur est survenu lors de la récupération des fichiers statiques du chat",MESSAGE_ERREUR_STATICS_WCB:"Une erreur est survenu lors de la récupération des fichiers statiques du webCallBack",MESSAGE_ERREUR_URL:"URL de la webapp n'est pas renseigné",constantes:{},chatData:{},businessData:{},userData:{},isChatOpen:false,isWcbOpen:false,authorizedKey:{},closeChatCallBackFunction:{},closeWCBCallBackFunction:{},isLogActivated:"MUP10".substr(0,3)!=="MUP",open_chat:function(b,c,d,a,e){BVER._log("- Ouverture du chat");BVER.authorizedKey=b.technical_chat.authorized_key;if(!BVER.isChatOpen){$.when(BVER._getConstante(BVER.URL_BVER_CONSTANTE)).then(function(g){BVER.constantes=g;var f=BVER._checkRequestAttributs(b.technical_chat,BVER.constantes.requiredTechnical.attributesOpenChat);var h=BVER._checkRequestAttributs(b.business_chat,BVER.constantes.requiredBusiness.attributes);if(f.length===0&&h.length===0){BVER.closeChatCallBackFunction=c;BVER._initializeChatWidget(b,d,a,e)}else{e({label_id:BVER._fromMissingAttrToString(f,h)})}},function(){a({label_id:BVER.MESSAGE_ERREUR_CONSTANTE})})}else{e({label_id:BVER.MESSAGE_ERREUR_CHAT_OPEN})}},_initializeChatWidget:function(b,c,a,d){$.when(BVER._getHtmlTemplate(BVER.constantes.path.chatTemplateHtml),BVER._getScript(BVER.constantes.path.chatwidgetJavascript),BVER._getScript(BVER.constantes.path.fileSaverJavascript),BVER._getConstante(BVER.constantes.path.chatStaticConstante)).then(function(h,g,f,e){BVER.businessData=b.business_chat;BVER._setAjaxBinaryProperty();CHAT_WIDGET.constantes=e[0];if($(b.technical_chat.div_id).length!=0){$(b.technical_chat.div_id).append(h[0])}else{a({label_id:BVER.constantes.DOMElementDoesNotExists})}CHAT_WIDGET.setChatData(b);CHAT_WIDGET.chatLoadingInitializer();BVER.isChatOpen=true;c()},function(){a({label_id:BVER.MESSAGE_ERREUR_STATICS_CHAT})})},update_data_chat:function(b,d,a,e){BVER._log("- Update des données du chat");if(BVER.isChatOpen){var c=BVER._checkRequestAttributs(b.technical_chat,BVER.constantes.requiredTechnical.attributesCloseRefreshChat);if(c.length===0){CHAT_WIDGET.setChatData(b);d()}else{a({label_id:BVER._fromMissingAttrToString(c)})}}else{e({label_id:BVER.MESSAGE_ERREUR_CHAT_NOT_OPEN})}},close_chat:function(b,d,a,e){BVER._log("- Fermeture du chat");if(BVER.isChatOpen){var c=BVER._checkRequestAttributs(b.technical_chat,BVER.constantes.requiredTechnical.attributesCloseRefreshChat);if(c.length===0){CHAT_WIDGET.killSession();CHAT_WIDGET.removeChat();d()}else{a({label_id:BVER._fromMissingAttrToString(c)})}}else{e({label_id:BVER.MESSAGE_ERREUR_CHAT_NOT_OPEN})}},open_wcb:function(d,c,b,a,e){BVER._log("- Ouverture du wcb");BVER.authorizedKey=d.technical_wcb.authorized_key;if(!BVER.isWcbOpen){$.when(BVER._getConstante(BVER.URL_BVER_CONSTANTE)).then(function(g){BVER.constantes=g;var f=BVER._checkRequestAttributs(d.technical_wcb,BVER.constantes.requiredTechnical.attributesOpenWcb);var h=BVER._checkRequestAttributs(d.business_wcb,BVER.constantes.requiredBusiness.attributesOpenWcb);if(f.length===0&&h.length===0){BVER.closeWCBCallBackFunction=c;BVER._initializeWcbWidget(d,b,a,e)}else{e({label_id:BVER._fromMissingAttrToString(f,h)})}},function(){a({label_id:BVER.MESSAGE_ERREUR_CONSTANTE})})}else{e({label_id:BVER.MESSAGE_ERREUR_WCB_OPEN})}},_initializeWcbWidget:function(c,b,a,d){$.when(BVER._getConstante(BVER.constantes.path.wcbStaticConstante),BVER._getHtmlTemplate(BVER.constantes.path.wcbTemplateHtml),BVER._getScript(BVER.constantes.path.wcbwidgetJavascript)).then(function(f,g,e){WCB_WIDGET.constantes=f[0];if($(c.technical_wcb.div_id)!=0){$(c.technical_wcb.div_id).append(g[0])}else{a({label_id:BVER.constantes.DOMElementDoesNotExists})}WCB_WIDGET.initializeWcb(c);BVER.isWcbOpen=true;b()},function(){a({label_id:BVER.MESSAGE_ERREUR_STATICS_WCB})})},close_wcb:function(){BVER._log("- Fermeture du wcb");if(BVER.isWcbOpen){removeWcb();successCallBack()}else{errorCallBack({label_id:BVER.MESSAGE_ERREUR_WCB_NOT_OPEN})}},_checkRequestAttributs:function(c,d){BVER._log("|- Vérification des paramètres d'entrée");var b=[];for(var a=0;a<d.length;a++){if(!c.hasOwnProperty(d[a])){b.push(d[a])}else{if(!c[d[a]]){b.push(d[a])}}}return b},_fromMissingAttrToString:function(d,c){var a="";if(d&&d.length!==0){a+=BVER.constantes.errorMessage.technicalAttributsMissing;for(var b=0;b<d.length;b++){a+=d[b]+" "}}if(c&&c.length!==0){a+=BVER.constantes.errorMessage.businessAttributsMissing;for(var e=0;e<c.length;e++){a+=c[e]+" "}}return a},_getConstante:function(a){return $.ajax({url:BVER.URL_OIC_SERVICES+a,headers:{authorizedKey:BVER.authorizedKey},dataType:"json",cache:false})},_getHtmlTemplate:function(a){return $.ajax({url:BVER.URL_OIC_SERVICES+a,headers:{authorizedKey:BVER.authorizedKey},dataType:"html",cache:false})},_getScript:function(a){return $.ajax({url:BVER.URL_OIC_SERVICES+a,headers:{authorizedKey:BVER.authorizedKey},dataType:"script",cache:false,crossDomain:false})},_log:function(a){if(BVER.isLogActivated){console.log(a)}},_setAjaxBinaryProperty:function(){$.ajaxTransport("+binary",function(a,c,b){if(window.FormData&&(a.dataType&&(a.dataType==="binary")||(a.data&&((window.ArrayBuffer&&a.data instanceof ArrayBuffer)||(window.Blob&&a.data instanceof Blob))))){return{send:function(e,n){var o=new XMLHttpRequest(),d=a.url,k=a.type,f=a.async||true,l=a.responseType||"blob",j=a.data||null,h=a.username||null,m=a.password||null;o.addEventListener("load",function(){var i={};i[a.dataType]=o.response;n(o.status,o.statusText,i,o.getAllResponseHeaders())});o.open(k,d,f,h,m);for(var g in e){if(e.hasOwnProperty(g)&&typeof e[g]!="function"){o.setRequestHeader(g,e[g])}}o.responseType=l;o.send(j)},abort:function(){b.abort()}}}})}};